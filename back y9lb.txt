
from ultralytics import YOLO
import cv2
import os
import numpy as np

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
model_card = YOLO("runs/detect/train25/weights/best.pt")  # Ù†Ù…ÙˆØ°Ø¬ ÙƒØ´Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
model_flag = YOLO("runs/detect/train/weights/best.pt")   # Ù†Ù…ÙˆØ°Ø¬ ÙƒØ´Ù Ø§Ù„Ø¹Ù„Ù…

# Ø¯Ø§Ù„Ø© Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØµÙˆØ±
def are_images_similar(img1, img2, threshold=0.7):
    img1 = cv2.resize(img1, (100, 100))
    img2 = cv2.resize(img2, (100, 100))
    diff = cv2.absdiff(img1, img2)
    similarity = 1 - (np.sum(diff) / (img1.size * 255))
    return similarity >= threshold, similarity

# Ù‚Øµ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
def extract_card(image_path, output_path="cropped_id.jpg"):
    image = cv2.imread(image_path)
    results = model_card(image_path)

    if len(results) == 0 or results[0].boxes is None or len(results[0].boxes) == 0:
        print("âŒ Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£ÙŠ Ø¨Ø·Ø§Ù‚Ø©.")
        return None, None

    box = results[0].boxes[0]
    x1, y1, x2, y2 = map(int, box.xyxy[0])
    cropped = image[y1:y2, x1:x2]
    cv2.imwrite(output_path, cropped)
    print(f"âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ: {output_path}")
    return cropped, output_path

# Ù‚Øµ Ø§Ù„Ø¹Ù„Ù…
def extract_flag(image, output_path="cropped_flag.jpg"):
    results = model_flag(image)
    if len(results) == 0 or results[0].boxes is None or len(results[0].boxes) == 0:
        print("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù„Ù….")
        return None
    box = results[0].boxes[0]
    x1, y1, x2, y2 = map(int, box.xyxy[0])
    flag = image[y1:y2, x1:x2]
    cv2.imwrite(output_path, flag)
    print(f"âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ù… ÙÙŠ: {output_path}")
    return flag

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (Ù…Ø¹ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¹Ù„Ù… Ø§Ù„Ù…Ù‚Ù„ÙˆØ¨)
def check_and_fix_orientation(card_img_path, flag_reference_path="flag_ref.jpg"):
    card_img = cv2.imread(card_img_path)
    flag_ref = cv2.imread(flag_reference_path)

    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù„Ù… Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    flag = extract_flag(card_img)
    if flag is None:
        print("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ù….")
        return card_img

    # Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ø±Ø¬Ø¹ ÙƒÙ…Ø§ Ù‡Ùˆ
    match_normal, sim_normal = are_images_similar(flag, flag_ref)

    # Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¹Ù„Ù… Ø§Ù„Ù…Ù‚Ù„ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ù…Ø±Ø¬Ø¹
    flag_rotated = cv2.rotate(flag, cv2.ROTATE_180)
    match_flipped, sim_flipped = are_images_similar(flag_rotated, flag_ref)

    print(f"ğŸ” Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ´Ø§Ø¨Ù‡ (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ): {round(sim_normal, 2)}")
    print(f"ğŸ”„ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ´Ø§Ø¨Ù‡ (Ø¨Ø¹Ø¯ Ù‚Ù„Ø¨ Ø§Ù„Ø¹Ù„Ù…): {round(sim_flipped, 2)}")

    # Ø§Ù„Ù‚Ø±Ø§Ø±: Ù‡Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµØ­ÙŠØ­ Ø£Ù… Ù„Ø§ØŸ
    if sim_normal >= sim_flipped:
        print("âœ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµØ­ÙŠØ­.")
        return card_img
    else:
        print("ğŸ” ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ØºÙŠØ± ØµØ­ÙŠØ­ØŒ Ø³ÙŠØªÙ… Ù‚Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©.")
        flipped_img = cv2.rotate(card_img, cv2.ROTATE_180)
        return flipped_img

# Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒØ§Ù…Ù„
def process_image(image_path, flag_reference_path="flag_ref.jpg"):
    # 1. Ù‚Øµ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    card_img, cropped_path = extract_card(image_path)
    if card_img is None:
        return

    # 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡
    final_card = check_and_fix_orientation(cropped_path, flag_reference_path)

    # 3. Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    final_output_path = "final_id.jpg"
    cv2.imwrite(final_output_path, final_card)
    print(f"âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙŠ: {final_output_path}")

# Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
process_image("20.jpg", "flag_ref.jpg")
